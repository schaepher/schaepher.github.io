<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>MySQL 自增主键 - Schaepher's Blog</title><meta name=Description content="深透理解，熟练运用；似懂非懂，其实不懂。"><meta property="og:title" content="MySQL 自增主键"><meta property="og:description" content="原文： MySQL 自增主键 https://schaepher.github.io/2020/04/28/mysql-auto-inc/ 以下仅考虑 InnoDB 存储引擎。 自增主键有两个性质需要考虑： 单调性 每次插入一条数据，其 ID 都是比上一条插入的数据的 ID 大，就算上一条数据"><meta property="og:type" content="article"><meta property="og:url" content="https://schaepher.github.io/2020/04/28/mysql-auto-inc/"><meta property="og:image" content="https://schaepher.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-28T21:16:00+00:00"><meta property="article:modified_time" content="2020-04-28T21:16:00+00:00"><meta property="og:site_name" content="Schaepher's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://schaepher.github.io/logo.png"><meta name=twitter:title content="MySQL 自增主键"><meta name=twitter:description content="原文： MySQL 自增主键 https://schaepher.github.io/2020/04/28/mysql-auto-inc/ 以下仅考虑 InnoDB 存储引擎。 自增主键有两个性质需要考虑： 单调性 每次插入一条数据，其 ID 都是比上一条插入的数据的 ID 大，就算上一条数据"><meta name=application-name content="Schaepher's Blog"><meta name=apple-mobile-web-app-title content="Schaepher's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://schaepher.github.io/2020/04/28/mysql-auto-inc/><link rel=prev href=https://schaepher.github.io/2020/04/26/high-cohesion-low-coupling/><link rel=next href=https://schaepher.github.io/2020/04/29/process/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"MySQL 自增主键","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/schaepher.github.io\/2020\/04\/28\/mysql-auto-inc\/"},"genre":"posts","keywords":"MySQL, 索引, 主键","wordcount":1373,"url":"https:\/\/schaepher.github.io\/2020\/04\/28\/mysql-auto-inc\/","datePublished":"2020-04-28T21:16:00+00:00","dateModified":"2020-04-28T21:16:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Schaepher"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Schaepher's Blog"></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>主页 </a><a class=menu-item href=/posts/ title=文章按年份分类>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Schaepher's Blog"></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/ title>主页</a><a class=menu-item href=/posts/ title=文章按年份分类>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">MySQL 自增主键</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://cnblogs.com/schaepher title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Schaepher</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-04-28>2020-04-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 1373 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 3 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#自增主键的单调性>自增主键的单调性</a><ul><li><a href=#自增主键最大值怎么取的存放到哪里>自增主键最大值怎么取的？存放到哪里？</a></li><li><a href=#如何解决单调性的问题>如何解决单调性的问题？</a></li></ul></li><li><a href=#自增主键插入时的连续性>自增主键插入时的连续性</a><ul><li><a href=#如何解决连续性问题>如何解决连续性问题？</a></li></ul></li><li><a href=#多事务批量插入的连续性>多事务批量插入的连续性</a></li><li><a href=#其他>其他</a></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div></div><div class=content id=content><p>原文：</p><blockquote><p>MySQL 自增主键<br><a href=https://schaepher.github.io/2020/04/28/mysql-auto-inc/ target=_blank rel="noopener noreffer">https://schaepher.github.io/2020/04/28/mysql-auto-inc/</a></p></blockquote><p>以下仅考虑 InnoDB 存储引擎。</p><p>自增主键有两个性质需要考虑：</p><ul><li>单调性<br>每次插入一条数据，其 ID 都是比上一条插入的数据的 ID 大，就算上一条数据被删除。</li><li>连续性<br>插入成功时，其数据的 ID 和前一次插入成功时数据的 ID 相邻。</li></ul><h2 id=自增主键的单调性>自增主键的单调性</h2><p>为何会有单调性的问题？</p><p>这主要跟自增主键最大值的获取方式，以及存放位置有关系。</p><p>如果最大值是通过计算获取的，并且在某些情况下需要重新获取时，会因为最新的数据被删除而减小。</p><h3 id=自增主键最大值怎么取的存放到哪里>自增主键最大值怎么取的？存放到哪里？</h3><p>MySQL 5.7 及之前的版本，自增主键最大值会在启动（重启）后从数据库中取出放到内存：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>ai_col</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=p>;</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>这样获取是通过计算的，并且由于存放在内存而容易丢失。</p><p>如果删除最新一条数据（假设 ID 为 10），因故障或者其他必要重启后再插入一条数据时会使用之前的 ID （即 ID 为 10）。</p><p>问题在于如果有其他表依赖了该 ID，则其他表的数据关联到的数据就符合要求了。除非设置了外键。</p><p>比如我要向最大一个 ID 的账号充了 100 万。但是在充值之前，该账号被删除，然后服务器故障重启，重启后有人新注册了一个账号。结果我的 100 万充到了他的新账号上。注册新账号的人以为是新手福利，笑嘻嘻。</p><h3 id=如何解决单调性的问题>如何解决单调性的问题？</h3><p>从 MySQL 8.0 开始，自增主键最大值会在每次修改后写入到 redo log，并且在每个检查点写入引擎私有的系统表。</p><ul><li>如果是正常重启，则读取系统表里的值。</li><li>如果是故障重启，则先读取系统表里的值放到内存。接着扫描 redo log 里存储的值。如果扫描到的值大于内存的值，则将该值覆盖到内存。</li></ul><p>但由于数据库可能在 redo log 刷入磁盘前就故障了，所以可能会用到之前申请的 ID。</p><p>注：如果 redo log 都没刷入，就更不用说将数据插入数据表了。</p><blockquote><p>InnoDB AUTO_INCREMENT Counter Initialization<br><a href=https://dev.mysql.com/doc/refman/8.0/en/innodb-auto-increment-handling.html#innodb-auto-increment-initialization target=_blank rel="noopener noreffer">https://dev.mysql.com/doc/refman/8.0/en/innodb-auto-increment-handling.html#innodb-auto-increment-initialization</a></p></blockquote><h2 id=自增主键插入时的连续性>自增主键插入时的连续性</h2><blockquote><p>这里不考虑由于删除导致的连续性问题</p></blockquote><p>为何会有连续性问题？</p><p>这主要是跟插入事务回滚有关系。</p><p>对于两个插入事务，事务 A 先执行插入语句，之后事务 B 执行插入语句。在这之后，事务 A 回滚，导致 A 执行插入语句时占用的 ID 被抛弃。</p><p>之所以事务 A 没提交的情况下，事务 B 就能执行插入语句，跟 InnoDB 的自增长锁（AUTO-INC Locking）相关。该锁是一种特殊的表锁（table-level lock），但会在插入语句执行后立即释放，不会等到事务结束。</p><h3 id=如何解决连续性问题>如何解决连续性问题？</h3><p>使用最高隔离级别 SERIALIZABLE （串行）。</p><p>由于性能上的考虑，通常不这样做。</p><h2 id=多事务批量插入的连续性>多事务批量插入的连续性</h2><p>事务 A 和事务 B 都在执行 <strong>不确定数量</strong> 的批量插入（INSERT &mldr; SELECT）：</p><ul><li>保证事务 A 的数据的 ID 连续： innodb_autoinc_lock_mode = 0 （AUTO-INC Locking）<br>必须等待语句执行结束才释放锁。</li><li>保证事务 A 的数据的 ID 连续： innodb_autoinc_lock_mode = 1 （AUTO-INC Locking）<br>和上面的区别在于，当执行 <strong>确定数量</strong> 的批量插入时，使用轻量级互斥量（mutex）而不是特殊表锁（AUTO-INC Locking），从而提前向内存的计数器申请相应数量的 ID。之后立即释放，不用等语句执行结束。<br>会因为回滚而使得全局 ID 不连续。</li><li>不保证事务 A 的数据的 ID 连续： innodb_autoinc_lock_mode = 2 （mutex）</li></ul><p>三种插入定义：</p><ul><li>简单插入<br>能够提前知道插入的行数</li><li>批量插入<br>不能提前知道插入的行数</li><li>混合插入<br>批量插入中的一部分的 ID 是指定的（非 0 且非 NULL），另一部分未指定，使用数据库生成的自增 ID。</li></ul><h2 id=其他>其他</h2><p>如果主动指定 ID 为 0 或者 NULL 插入，则会使用数据库生成的自增 ID。</p><h2 id=参考文档>参考文档</h2><blockquote><p>为什么 MySQL 的自增主键不单调也不连续<br><a href=https://database.51cto.com/art/202004/614923.htm target=_blank rel="noopener noreffer">https://database.51cto.com/art/202004/614923.htm</a><br>《MySQL技术内幕——InnoDB存储引擎》 第 6 章：锁</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-04-28</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2020/04/28/mysql-auto-inc/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://schaepher.github.io/2020/04/28/mysql-auto-inc/ data-title="MySQL 自增主键" data-hashtags=MySQL,索引,主键><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://schaepher.github.io/2020/04/28/mysql-auto-inc/ data-hashtag=MySQL><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://schaepher.github.io/2020/04/28/mysql-auto-inc/ data-title="MySQL 自增主键"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://schaepher.github.io/2020/04/28/mysql-auto-inc/ data-title="MySQL 自增主键"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://schaepher.github.io/2020/04/28/mysql-auto-inc/ data-title="MySQL 自增主键"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://schaepher.github.io/2020/04/28/mysql-auto-inc/ data-title="MySQL 自增主键"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/mysql/>MySQL</a>,&nbsp;<a href=/tags/%E7%B4%A2%E5%BC%95/>索引</a>,&nbsp;<a href=/tags/%E4%B8%BB%E9%94%AE/>主键</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2020/04/26/high-cohesion-low-coupling/ class=prev rel=prev title=高内聚与低耦合><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>高内聚与低耦合</a>
<a href=/2020/04/29/process/ class=next rel=next title=孤儿进程和僵尸（僵死）进程>孤儿进程和僵尸（僵死）进程<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://cnblogs.com/schaepher target=_blank>Schaepher</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>